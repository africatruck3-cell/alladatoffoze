<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zone Sanitaire ALLADA-TOFFO-ZE</title>
<meta name="description" content="Application de gestion du parc automobile de la Zone Sanitaire Allada-Toffo-Z√®">
<meta name="author" content="Zone Sanitaire ATZ">

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöó</text></svg>">

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
    --primary: #0d3b66;
    --primary-light: #1a5490;
    --secondary: #2a9d8f;
    --secondary-light: #3db8a9;
    --accent: #e76f51;
    --warning: #f4a261;
    --danger: #e63946;
    --success: #2a9d8f;
    --bg-light: #f8fafc;
    --bg-card: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --border: #e2e8f0;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --radius: 12px;
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    color: var(--text-primary);
    line-height: 1.6;
}

/* Header */
header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-lg);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-brand {
    display: flex;
    align-items: center;
    gap: 12px;
}

.header-brand i {
    font-size: 1.8rem;
}

.header-brand h1 {
    font-size: 1.4rem;
    font-weight: 600;
}

.header-brand span {
    font-size: 0.85rem;
    opacity: 0.9;
    font-weight: 400;
}

.header-actions {
    display: flex;
    gap: 10px;
}

/* Container */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

/* Cards */
.card {
    background: var(--bg-card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border);
    transition: var(--transition);
}

.card:hover {
    box-shadow: var(--shadow-lg);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--bg-light);
}

.card-header i {
    font-size: 1.5rem;
    color: var(--primary);
    background: rgba(13, 59, 102, 0.1);
    padding: 12px;
    border-radius: 10px;
}

.card-header h2 {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--primary);
}

/* Forms */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.25rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.form-group label i {
    font-size: 0.8rem;
    color: var(--primary);
}

.form-control {
    padding: 12px 14px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 0.95rem;
    font-family: inherit;
    transition: var(--transition);
    background: var(--bg-light);
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 3px rgba(13, 59, 102, 0.1);
}

.form-control::placeholder {
    color: var(--text-secondary);
    opacity: 0.7;
}

select.form-control {
    cursor: pointer;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
}

.btn:hover {
    transform: translateY(-2px);
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
}

.btn-primary:hover {
    box-shadow: 0 4px 12px rgba(13, 59, 102, 0.4);
}

.btn-success {
    background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%);
    color: white;
}

.btn-success:hover {
    box-shadow: 0 4px 12px rgba(42, 157, 143, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger) 0%, #ff6b6b 100%);
    color: white;
}

.btn-danger:hover {
    box-shadow: 0 4px 12px rgba(230, 57, 70, 0.4);
}

.btn-warning {
    background: linear-gradient(135deg, var(--warning) 0%, #f8b26a 100%);
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
    color: white;
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-outline:hover {
    background: var(--primary);
    color: white;
}

.btn-sm {
    padding: 8px 12px;
    font-size: 0.85rem;
}

.btn-icon {
    padding: 10px;
    border-radius: 8px;
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.25rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: var(--transition);
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stat-icon.blue {
    background: rgba(13, 59, 102, 0.1);
    color: var(--primary);
}

.stat-icon.green {
    background: rgba(42, 157, 143, 0.1);
    color: var(--secondary);
}

.stat-icon.orange {
    background: rgba(244, 162, 97, 0.1);
    color: var(--warning);
}

.stat-icon.red {
    background: rgba(230, 57, 70, 0.1);
    color: var(--danger);
}

.stat-content h3 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
}

.stat-content p {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 4px;
}

/* Table */
.table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
}

thead {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
}

th {
    color: white;
    padding: 14px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
    font-size: 0.95rem;
}

tbody tr {
    transition: var(--transition);
}

tbody tr:hover {
    background: var(--bg-light);
}

.centre-row {
    background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%) !important;
    font-weight: 600;
}

.centre-row td {
    padding: 10px 12px;
    color: var(--primary);
    border-bottom: 2px solid var(--primary);
}

/* Action Buttons in Table */
.action-btns {
    display: flex;
    gap: 6px;
}

.action-btns .btn {
    padding: 6px 10px;
    font-size: 0.8rem;
}

/* Missing Centers Alert */
.alert {
    padding: 1.25rem;
    border-radius: var(--radius);
    margin-top: 1.5rem;
}

.alert-warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid var(--warning);
}

.alert-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 1rem;
}

.alert-header i {
    font-size: 1.3rem;
    color: var(--warning);
}

.alert-header h4 {
    font-size: 1rem;
    color: var(--text-primary);
}

.missing-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px;
    list-style: none;
}

.missing-list li {
    background: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.missing-list li::before {
    content: "‚ö†";
    font-size: 0.8rem;
}

/* Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: white;
    border-radius: var(--radius);
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: var(--transition);
}

.modal-overlay.active .modal {
    transform: scale(1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--bg-light);
}

.modal-header h3 {
    font-size: 1.25rem;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
    transition: var(--transition);
}

.modal-close:hover {
    color: var(--danger);
}

.modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 2px solid var(--bg-light);
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    animation: slideIn 0.3s ease;
    border-left: 4px solid;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast.success {
    border-left-color: var(--success);
}

.toast.success i {
    color: var(--success);
}

.toast.error {
    border-left-color: var(--danger);
}

.toast.error i {
    color: var(--danger);
}

.toast.warning {
    border-left-color: var(--warning);
}

.toast.warning i {
    color: var(--warning);
}

.toast i {
    font-size: 1.2rem;
}

.toast-content {
    flex: 1;
}

.toast-content strong {
    display: block;
    margin-bottom: 2px;
}

.toast-content span {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

/* Badges */
.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.badge-success {
    background: rgba(42, 157, 143, 0.15);
    color: var(--secondary);
}

.badge-warning {
    background: rgba(244, 162, 97, 0.15);
    color: #c77d32;
}

.badge-danger {
    background: rgba(230, 57, 70, 0.15);
    color: var(--danger);
}

/* Footer */
footer {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

footer a {
    color: var(--primary);
    text-decoration: none;
}

/* Search & Filter */
.toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
    align-items: center;
}

.search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.search-box i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.search-box input {
    width: 100%;
    padding: 12px 14px 12px 42px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 0.95rem;
    transition: var(--transition);
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(13, 59, 102, 0.1);
}

/* Responsive */
@media (max-width: 768px) {
    header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .header-actions {
        width: 100%;
        justify-content: center;
    }
    
    .container {
        padding: 1rem;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .toolbar {
        flex-direction: column;
    }
    
    .search-box {
        width: 100%;
    }
}

/* Carte Grise Upload */
.upload-zone {
    border: 2px dashed var(--border);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    background: var(--bg-light);
    position: relative;
    overflow: hidden;
}

.upload-zone:hover {
    border-color: var(--primary);
    background: rgba(13, 59, 102, 0.05);
}

.upload-zone.has-file {
    border-color: var(--success);
    background: rgba(42, 157, 143, 0.05);
}

.upload-zone input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.upload-zone i {
    font-size: 2rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.upload-zone.has-file i {
    color: var(--success);
}

.upload-zone p {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.upload-zone .file-name {
    font-weight: 600;
    color: var(--success);
    margin-top: 4px;
}

.upload-preview {
    margin-top: 10px;
    max-width: 100%;
    max-height: 120px;
    border-radius: 8px;
    object-fit: contain;
    display: none;
}

.upload-preview.visible {
    display: block;
}

.cg-thumbnail {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid var(--border);
    transition: var(--transition);
}

.cg-thumbnail:hover {
    transform: scale(1.1);
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.cg-actions {
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-download-cg {
    padding: 6px 8px;
    font-size: 0.75rem;
    border-radius: 6px;
    background: var(--primary);
    color: white;
    border: none;
    cursor: pointer;
    transition: var(--transition);
}

.btn-download-cg:hover {
    background: var(--primary-light);
    transform: scale(1.05);
}

/* Image Viewer Modal */
.image-viewer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    flex-direction: column;
    gap: 15px;
}

.image-viewer-overlay.active {
    display: flex;
}

.image-viewer-overlay img {
    max-width: 90%;
    max-height: 75vh;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.image-viewer-toolbar {
    display: flex;
    gap: 10px;
}

.image-viewer-toolbar button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: var(--transition);
}

.image-viewer-toolbar .btn-download {
    background: var(--success);
    color: white;
}

.image-viewer-toolbar .btn-download:hover {
    background: var(--secondary-light);
}

.image-viewer-toolbar .btn-close-viewer {
    background: rgba(255,255,255,0.2);
    color: white;
}

.image-viewer-toolbar .btn-close-viewer:hover {
    background: rgba(255,255,255,0.3);
}

/* Utilities */
.hidden {
    display: none !important;
}

.text-center {
    text-align: center;
}

.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }

/* Print Styles */
@media print {
    header, .btn, .toolbar, .alert {
        display: none !important;
    }
    
    .card {
        box-shadow: none;
        border: 1px solid #ddd;
    }
}
</style>
</head>

<body>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Header -->
<header>
    <div class="header-brand">
        <i class="fas fa-hospital-alt"></i>
        <div>
            <h1>Gestion du Parc Automobile</h1>
            <span>Zone Sanitaire Allada-Toffo-Z√®</span>
        </div>
    </div>
    <div class="header-actions">
        <button class="btn btn-outline" onclick="adminLogin()" style="border-color: white; color: white;">
            <i class="fas fa-lock"></i> Espace Admin
        </button>
    </div>
</header>

<div class="container">

    <!-- Form Section -->
    <div id="formSection" class="card">
        <div class="card-header">
            <i class="fas fa-car-side"></i>
            <h2>D√©claration d'un V√©hicule</h2>
        </div>

        <form id="vehicleForm">
            <div class="form-grid">
                <div class="form-group">
                    <label><i class="fas fa-hospital"></i> Centre de Sant√©</label>
                    <select id="centre" class="form-control" required>
                        <option value="">-- S√©lectionner votre centre --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-car"></i> Type de V√©hicule</label>
                    <select id="type" class="form-control" required>
                        <option value="">-- S√©lectionner le type --</option>
                        <option value="Moto">üèçÔ∏è Moto</option>
                        <option value="Voiture">üöó Voiture</option>
                        <option value="Ambulance">üöë Ambulance</option>
                        <option value="Camion">üöõ Camion</option>
                        <option value="Autre">üì¶ Autre</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> Immatriculation</label>
                    <input type="text" id="immatriculation" class="form-control" placeholder="Ex: AB 1234 RB" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-barcode"></i> Num√©ro de Ch√¢ssis</label>
                    <input type="text" id="chassis" class="form-control" placeholder="17 caract√®res" required minlength="5">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> Ann√©e d'Acquisition</label>
                    <input type="number" id="annee" class="form-control" placeholder="Ex: 2020" required min="1990" max="2030">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-tachometer-alt"></i> Kilom√©trage Actuel</label>
                    <input type="number" id="km" class="form-control" placeholder="Ex: 50000" required min="0">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-thermometer-half"></i> √âtat du V√©hicule</label>
                    <select id="etat" class="form-control" required>
                        <option value="Bon">‚úÖ Bon √©tat</option>
                        <option value="Moyen">‚ö†Ô∏è √âtat moyen</option>
                        <option value="Mauvais">‚ùå Mauvais √©tat</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-gas-pump"></i> Carburant</label>
                    <select id="carburant" class="form-control" required>
                        <option value="Essence">‚õΩ Essence</option>
                        <option value="Diesel">üõ¢Ô∏è Diesel</option>
                        <option value="√âlectrique">‚ö° √âlectrique</option>
                    </select>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-file-alt"></i> Photo Carte Grise</label>
                    <div class="upload-zone" id="carteGriseZone">
                        <input type="file" id="carteGrise" accept="image/*" onchange="previewCarteGrise(this, 'carteGrisePreview', 'carteGriseZone')">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Cliquez ou glissez l'image ici</p>
                        <p class="file-name" id="carteGriseFileName"></p>
                        <img class="upload-preview" id="carteGrisePreview" alt="Aper√ßu carte grise">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label><i class="fas fa-comment-alt"></i> Observations</label>
                    <textarea id="obs" class="form-control" placeholder="Informations compl√©mentaires sur le v√©hicule..."></textarea>
                </div>

                <div class="form-group full-width">
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-save"></i> Enregistrer le V√©hicule
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Admin Section -->
    <div id="adminSection" class="hidden">
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-car"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalVehicules">0</h3>
                    <p>Total V√©hicules</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-hospital-user"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalCentres">0</h3>
                    <p>Centres ayant soumis</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3 id="centresRestants">0</h3>
                    <p>Centres en attente</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon red">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3 id="vehiculesMauvais">0</h3>
                    <p>V√©hicules en mauvais √©tat</p>
                </div>
            </div>
        </div>

        <!-- Data Table Card -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table"></i>
                <h2>Liste des V√©hicules D√©clar√©s</h2>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Rechercher par centre, immatriculation..." onkeyup="filterTable()">
                </div>
                
                <select id="filterEtat" class="form-control" style="width: auto;" onchange="filterTable()">
                    <option value="">Tous les √©tats</option>
                    <option value="Bon">‚úÖ Bon</option>
                    <option value="Moyen">‚ö†Ô∏è Moyen</option>
                    <option value="Mauvais">‚ùå Mauvais</option>
                </select>

                <button class="btn btn-success" onclick="exportExcel()">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button class="btn btn-danger" onclick="exportPDF()">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Fermer
                </button>
            </div>

            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Centre</th>
                            <th>Type</th>
                            <th>Immatriculation</th>
                            <th>Ch√¢ssis</th>
                            <th>Ann√©e</th>
                            <th>KM</th>
                            <th>√âtat</th>
                            <th>Carburant</th>
                            <th>Carte Grise</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Missing Centers Alert -->
            <div class="alert alert-warning" id="missingAlert">
                <div class="alert-header">
                    <i class="fas fa-exclamation-circle"></i>
                    <h4>Centres n'ayant pas encore d√©clar√© leurs v√©hicules</h4>
                </div>
                <ul class="missing-list" id="missingList"></ul>
            </div>
        </div>
    </div>

</div>

<!-- Footer -->
<footer>
    <p>¬© 2025 Zone Sanitaire Allada-Toffo-Z√® | D√©velopp√© avec ‚ù§Ô∏è pour la sant√© publique</p>
</footer>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Modifier le V√©hicule</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <form id="editForm">
            <input type="hidden" id="editCentre">
            <input type="hidden" id="editIndex">
            
            <div class="form-group mb-2">
                <label>Type</label>
                <select id="editType" class="form-control" required>
                    <option value="Moto">Moto</option>
                    <option value="Voiture">Voiture</option>
                    <option value="Ambulance">Ambulance</option>
                    <option value="Camion">Camion</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            
            <div class="form-group mb-2">
                <label>Immatriculation</label>
                <input type="text" id="editImmat" class="form-control" required>
            </div>
            
            <div class="form-group mb-2">
                <label>Ch√¢ssis</label>
                <input type="text" id="editChassis" class="form-control" required>
            </div>
            
            <div class="form-group mb-2">
                <label>Ann√©e</label>
                <input type="number" id="editAnnee" class="form-control" required>
            </div>
            
            <div class="form-group mb-2">
                <label>Kilom√©trage</label>
                <input type="number" id="editKm" class="form-control" required>
            </div>
            
            <div class="form-group mb-2">
                <label>√âtat</label>
                <select id="editEtat" class="form-control" required>
                    <option value="Bon">Bon</option>
                    <option value="Moyen">Moyen</option>
                    <option value="Mauvais">Mauvais</option>
                </select>
            </div>
            
            <div class="form-group mb-2">
                <label>Carburant</label>
                <select id="editCarburant" class="form-control" required>
                    <option value="Essence">Essence</option>
                    <option value="Diesel">Diesel</option>
                    <option value="√âlectrique">√âlectrique</option>
                </select>
            </div>

            <div class="form-group mb-2">
                <label>Photo Carte Grise</label>
                <div class="upload-zone" id="editCarteGriseZone">
                    <input type="file" id="editCarteGrise" accept="image/*" onchange="previewCarteGrise(this, 'editCarteGrisePreview', 'editCarteGriseZone')">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Cliquez ou glissez pour changer l'image</p>
                    <p class="file-name" id="editCarteGriseFileName"></p>
                    <img class="upload-preview" id="editCarteGrisePreview" alt="Aper√ßu carte grise">
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Sauvegarder
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-trash-alt" style="color: var(--danger);"></i> Confirmer la suppression</h3>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        
        <p>√ätes-vous s√ªr de vouloir supprimer ce v√©hicule ? Cette action est irr√©versible.</p>
        
        <input type="hidden" id="deleteCentre">
        <input type="hidden" id="deleteIndex">
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Annuler</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                <i class="fas fa-trash"></i> Supprimer
            </button>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="image-viewer-overlay" id="imageViewer">
    <img id="imageViewerImg" src="" alt="Carte Grise">
    <div class="image-viewer-toolbar">
        <button class="btn-download" id="imageViewerDownload">
            <i class="fas fa-download"></i> T√©l√©charger
        </button>
        <button class="btn-close-viewer" onclick="closeImageViewer()">
            <i class="fas fa-times"></i> Fermer
        </button>
    </div>
</div>

<!-- Admin Login Modal -->
<div class="modal-overlay" id="loginModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-shield-alt"></i> Acc√®s Administrateur</h3>
            <button class="modal-close" onclick="closeLoginModal()">&times;</button>
        </div>
        
        <form id="loginForm" onsubmit="checkAdminCode(event)">
            <div class="form-group mb-2">
                <label><i class="fas fa-key"></i> Code d'acc√®s</label>
                <input type="password" id="adminCode" class="form-control" placeholder="Entrez le code admin" required autofocus>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeLoginModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Connexion
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// =====================================================
// CONFIGURATION
// =====================================================
const CONFIG = {
    ADMIN_CODE: "ATZ2025",
    STORAGE_KEY: "vehicules_zone_atz",
    APP_VERSION: "3.0.0"
};

// =====================================================
// üìå BASE DE DONN√âES EN LIGNE (Firebase REST API)
// =====================================================
// INSTRUCTIONS SIMPLES (3 minutes) :
// 1. Allez sur https://console.firebase.google.com
// 2. Cliquez "Ajouter un projet" > nommez-le > Continuer
// 3. Menu gauche : "Cr√©er" > "Realtime Database" > "Cr√©er"
// 4. Choisissez "Mode test" > Activer
// 5. Copiez l'URL affich√©e (ex: https://mon-projet-default-rtdb.firebaseio.com)
// 6. Collez-la ci-dessous entre les guillemets √† la place de ""
//
// C'EST TOUT ! Juste UNE seule URL √† coller :
const FIREBASE_URL = "https://parc-auto-atz-default-rtdb.firebaseio.com";
// Base de donn√©es Firebase configur√©e ‚úÖ

let firebaseReady = (FIREBASE_URL !== "");
let cachedData = {};
let isLoadingData = false;

if (firebaseReady) {
    console.log("‚úÖ Base de donn√©es en ligne active :", FIREBASE_URL);
} else {
    console.warn("‚ö†Ô∏è Base de donn√©es non configur√©e - Mode hors ligne (localStorage)");
}

// =====================================================
// FONCTIONS API REST FIREBASE
// =====================================================
async function fbGet() {
    try {
        const response = await fetch(FIREBASE_URL + '/vehicules.json');
        if (!response.ok) throw new Error('Erreur r√©seau');
        const rawData = await response.json();
        cachedData = {};
        if (rawData) {
            Object.keys(rawData).forEach(centre => {
                cachedData[centre] = [];
                const centreData = rawData[centre];
                if (centreData && typeof centreData === 'object') {
                    Object.keys(centreData).forEach(key => {
                        cachedData[centre].push({ ...centreData[key], _key: key });
                    });
                }
            });
        }
        return cachedData;
    } catch(e) {
        console.error('Erreur lecture Firebase:', e);
        showToast('Erreur', 'Impossible de charger les donn√©es en ligne', 'error');
        return cachedData;
    }
}

async function fbPush(centre, vehicule) {
    const response = await fetch(FIREBASE_URL + '/vehicules/' + encodeURIComponent(centre) + '.json', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(vehicule)
    });
    if (!response.ok) throw new Error('Erreur enregistrement');
    return await response.json();
}

async function fbUpdate(centre, key, data) {
    const response = await fetch(FIREBASE_URL + '/vehicules/' + encodeURIComponent(centre) + '/' + key + '.json', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Erreur mise √† jour');
    return await response.json();
}

async function fbDelete(centre, key) {
    const response = await fetch(FIREBASE_URL + '/vehicules/' + encodeURIComponent(centre) + '/' + key + '.json', {
        method: 'DELETE'
    });
    if (!response.ok) throw new Error('Erreur suppression');
}

// =====================================================
// RAFRA√éCHISSEMENT AUTOMATIQUE
// =====================================================
let refreshInterval = null;

function startAutoRefresh() {
    if (!firebaseReady) return;
    // Rafra√Æchir toutes les 10 secondes quand admin est connect√©
    refreshInterval = setInterval(async () => {
        if (!document.getElementById('adminSection').classList.contains('hidden')) {
            await fbGet();
            loadData();
        }
    }, 10000);
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// Liste des centres de sant√© de la zone ATZ
const centresList = [
    "CS Ahouannonzoun", "CS Soyo", "CS Lissegazoun", "CS Attogon", 
    "CS Togoudo", "CS Lon Agonmey", "CS Hinvi", "CS Ayou", 
    "CS Aota", "CS Avakpa", "CS Topka", "CS S√©kou", 
    "CS Agbanou", "CS Allada", "H√¥pital de Zone Allada-Toffo-Z√®", 
    "Bureau de Zone ATZ", "CS Djanglanme", "CS Agon", 
    "CS Dame", "CS Kpom√®", "CS Hou√®gbo", "CS S√®hou√®", 
    "CS Colli", "CS Sey", "CS Agu√©", "CS Coussi", 
    "CS Toffo Centre", "CS Daw√©", "CS Ahozonnoude", "CS Z√®", 
    "CS Dodji-Bata", "CS Sedjed√©nou", "CS Tangbo", "CS Djigb√©-Agu√©", 
    "CS Adjan", "CS Koundokpo√©"
].sort();

// =====================================================
// INITIALISATION
// =====================================================
document.addEventListener('DOMContentLoaded', function() {
    initCentreSelect();
    initFormValidation();
    initEditForm();
    
    // Indicateur de connexion
    const footer = document.querySelector('footer p');
    if (firebaseReady) {
        footer.innerHTML += ' | <span style="color: #2a9d8f;">üü¢ Base de donn√©es en ligne</span>';
    } else {
        footer.innerHTML += ' | <span style="color: #f4a261;">üü° Mode local uniquement</span>';
    }
});

function initCentreSelect() {
    const centreSelect = document.getElementById("centre");
    centresList.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        centreSelect.appendChild(opt);
    });
}

function initFormValidation() {
    document.getElementById("vehicleForm").addEventListener("submit", handleFormSubmit);
}

function initEditForm() {
    document.getElementById("editForm").addEventListener("submit", handleEditSubmit);
}

// =====================================================
// STORAGE FUNCTIONS
// =====================================================
function getData() {
    if (firebaseReady) {
        return cachedData;
    }
    try {
        return JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY)) || {};
    } catch (e) {
        console.error("Erreur de lecture des donn√©es:", e);
        return {};
    }
}

function saveData(data) {
    try {
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data));
        return true;
    } catch (e) {
        console.error("Erreur de sauvegarde:", e);
        showToast("Erreur", "Impossible de sauvegarder les donn√©es", "error");
        return false;
    }
}

function getVehicle(centre, id) {
    const data = getData();
    if (!data[centre]) return null;
    if (firebaseReady) {
        return data[centre].find(item => item._key === id) || null;
    }
    return data[centre][parseInt(id)] || null;
}

// =====================================================
// TOAST NOTIFICATIONS
// =====================================================
function showToast(title, message, type = "success") {
    const container = document.getElementById("toastContainer");
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    
    const icons = {
        success: "fa-check-circle",
        error: "fa-times-circle",
        warning: "fa-exclamation-triangle"
    };
    
    toast.innerHTML = `
        <i class="fas ${icons[type]}"></i>
        <div class="toast-content">
            <strong>${title}</strong>
            <span>${message}</span>
        </div>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = "slideIn 0.3s ease reverse";
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// =====================================================
// CARTE GRISE IMAGE FUNCTIONS
// =====================================================
function previewCarteGrise(input, previewId, zoneId) {
    const preview = document.getElementById(previewId);
    const zone = document.getElementById(zoneId);
    const fileNameEl = zone.querySelector('.file-name');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validate file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            showToast("Erreur", "L'image ne doit pas d√©passer 2 Mo", "error");
            input.value = "";
            return;
        }
        
        // Compress and preview
        const reader = new FileReader();
        reader.onload = function(e) {
            // Compress image
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const maxWidth = 1200;
                const maxHeight = 900;
                let { width, height } = img;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width *= ratio;
                    height *= ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                const compressed = canvas.toDataURL('image/jpeg', 0.7);
                preview.src = compressed;
                preview.classList.add("visible");
                zone.classList.add("has-file");
                fileNameEl.textContent = file.name;
                
                // Store compressed version in a data attribute for retrieval
                input.dataset.compressed = compressed;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function resetUploadZone(previewId, zoneId, fileNameId) {
    const preview = document.getElementById(previewId);
    const zone = document.getElementById(zoneId);
    const fileNameEl = document.getElementById(fileNameId);
    if (preview) {
        preview.src = "";
        preview.classList.remove("visible");
    }
    if (zone) zone.classList.remove("has-file");
    if (fileNameEl) fileNameEl.textContent = "";
}

function viewCarteGrise(centre, id) {
    const v = getVehicle(centre, id);
    if (v && v.carteGriseImage) {
        const viewer = document.getElementById("imageViewer");
        const img = document.getElementById("imageViewerImg");
        img.src = v.carteGriseImage;
        viewer.classList.add("active");
        
        document.getElementById("imageViewerDownload").onclick = function() {
            downloadCarteGrise(centre, id);
        };
    }
}

function closeImageViewer() {
    document.getElementById("imageViewer").classList.remove("active");
}

function downloadCarteGrise(centre, id) {
    const v = getVehicle(centre, id);
    if (v && v.carteGriseImage) {
        const link = document.createElement('a');
        link.href = v.carteGriseImage;
        link.download = `carte_grise_${v.immatriculation.replace(/\s+/g, '_')}_${centre.replace(/\s+/g, '_')}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("T√©l√©chargement", "Carte grise t√©l√©charg√©e", "success");
    } else {
        showToast("Erreur", "Aucune carte grise disponible", "warning");
    }
}

// =====================================================
// FORM HANDLING
// =====================================================
async function handleFormSubmit(e) {
    e.preventDefault();
    
    const centre = document.getElementById("centre").value;
    const data = getData();
    const centreVehicles = data[centre] || [];
    
    const vehicule = {
        type: document.getElementById("type").value,
        immatriculation: document.getElementById("immatriculation").value.toUpperCase(),
        chassis: document.getElementById("chassis").value.toUpperCase(),
        annee: document.getElementById("annee").value,
        km: document.getElementById("km").value,
        etat: document.getElementById("etat").value,
        carburant: document.getElementById("carburant").value,
        carteGriseImage: null,
        observations: document.getElementById("obs").value,
        date: new Date().toLocaleDateString("fr-FR"),
        timestamp: Date.now()
    };
    
    // V√©rifier si l'immatriculation existe d√©j√†
    const exists = centreVehicles.some(v => v.immatriculation === vehicule.immatriculation);
    if (exists) {
        showToast("Attention", "Ce v√©hicule est d√©j√† enregistr√©", "warning");
        return;
    }
    
    // Handle carte grise image
    const cgInput = document.getElementById("carteGrise");
    const cgCompressed = cgInput.dataset.compressed;
    if (cgCompressed) {
        vehicule.carteGriseImage = cgCompressed;
    }
    
    const resetForm = () => {
        e.target.reset();
        cgInput.dataset.compressed = "";
        resetUploadZone('carteGrisePreview', 'carteGriseZone', 'carteGriseFileName');
    };
    
    if (firebaseReady) {
        try {
            await fbPush(centre, vehicule);
            showToast("Succ√®s", "V√©hicule enregistr√© dans la base de donn√©es", "success");
            resetForm();
        } catch(err) {
            showToast("Erreur", "Erreur d'enregistrement: " + err.message, "error");
        }
    } else {
        if (!data[centre]) data[centre] = [];
        data[centre].push(vehicule);
        if (saveData(data)) {
            showToast("Succ√®s", "V√©hicule enregistr√© (mode local)", "success");
            resetForm();
        }
    }
}

// =====================================================
// ADMIN AUTHENTICATION
// =====================================================
function adminLogin() {
    document.getElementById("loginModal").classList.add("active");
    document.getElementById("adminCode").focus();
}

function closeLoginModal() {
    document.getElementById("loginModal").classList.remove("active");
    document.getElementById("adminCode").value = "";
}

function checkAdminCode(e) {
    e.preventDefault();
    const code = document.getElementById("adminCode").value;
    
    if (code === CONFIG.ADMIN_CODE) {
        closeLoginModal();
        document.getElementById("formSection").classList.add("hidden");
        document.getElementById("adminSection").classList.remove("hidden");
        
        // Charger les donn√©es depuis Firebase si connect√©
        if (firebaseReady) {
            showToast("Chargement", "R√©cup√©ration des donn√©es en ligne...", "warning");
            fbGet().then(() => {
                loadData();
                startAutoRefresh();
                showToast("Bienvenue", "Donn√©es synchronis√©es depuis la base en ligne", "success");
            });
        } else {
            loadData();
            showToast("Bienvenue", "Connect√© en mode local", "success");
        }
    } else {
        showToast("Erreur", "Code d'acc√®s incorrect", "error");
        document.getElementById("adminCode").value = "";
    }
}

function logout() {
    document.getElementById("adminSection").classList.add("hidden");
    document.getElementById("formSection").classList.remove("hidden");
    stopAutoRefresh();
    showToast("D√©connexion", "Session administrateur ferm√©e", "success");
}

// =====================================================
// DATA DISPLAY
// =====================================================
function loadData() {
    const data = getData();
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    
    let totalVeh = 0;
    let vehiculesMauvais = 0;
    const centresSoumis = Object.keys(data);
    
    centresSoumis.sort().forEach(centre => {
        // Row for centre name
        const centreRow = tbody.insertRow();
        centreRow.classList.add("centre-row");
        const cell = centreRow.insertCell(0);
        cell.colSpan = 11;
        cell.innerHTML = `<i class="fas fa-hospital"></i> ${centre} <span style="font-weight: normal;">(${data[centre].length} v√©hicule(s))</span>`;
        
        // Rows for vehicles
        data[centre].forEach((v, index) => {
            const vehicleId = (firebaseReady && v._key) ? v._key : String(index);
            totalVeh++;
            if (v.etat === "Mauvais") vehiculesMauvais++;
            
            const row = tbody.insertRow();
            row.dataset.centre = centre;
            row.dataset.index = vehicleId;
            row.dataset.searchable = `${centre} ${v.type} ${v.immatriculation} ${v.chassis}`.toLowerCase();
            row.dataset.etat = v.etat;
            
            row.insertCell(0).innerText = "";
            row.insertCell(1).innerText = v.type;
            row.insertCell(2).innerHTML = `<strong>${v.immatriculation}</strong>`;
            row.insertCell(3).innerText = v.chassis;
            row.insertCell(4).innerText = v.annee;
            row.insertCell(5).innerText = Number(v.km).toLocaleString() + " km";
            
            // √âtat avec badge
            const etatCell = row.insertCell(6);
            const badgeClass = v.etat === "Bon" ? "badge-success" : v.etat === "Moyen" ? "badge-warning" : "badge-danger";
            etatCell.innerHTML = `<span class="badge ${badgeClass}">${v.etat}</span>`;
            
            row.insertCell(7).innerText = v.carburant || "N/A";
            
            // Carte Grise image
            const cgCell = row.insertCell(8);
            if (v.carteGriseImage) {
                cgCell.innerHTML = `
                    <div class="cg-actions">
                        <img src="${v.carteGriseImage}" class="cg-thumbnail" onclick="viewCarteGrise('${centre}', '${vehicleId}')" title="Voir la carte grise">
                        <button class="btn-download-cg" onclick="downloadCarteGrise('${centre}', '${vehicleId}')" title="T√©l√©charger">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>`;
            } else {
                cgCell.innerHTML = `<span class="badge badge-warning">Non fournie</span>`;
            }
            
            row.insertCell(9).innerText = v.date;
            
            // Actions
            const actionsCell = row.insertCell(10);
            actionsCell.innerHTML = `
                <div class="action-btns">
                    <button class="btn btn-sm btn-primary" onclick="editVehicle('${centre}', '${vehicleId}')" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteVehicle('${centre}', '${vehicleId}')" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        });
    });
    
    // Update stats
    document.getElementById("totalVehicules").innerText = totalVeh;
    document.getElementById("totalCentres").innerText = centresSoumis.length;
    document.getElementById("vehiculesMauvais").innerText = vehiculesMauvais;
    
    // Missing centres
    const centresRestants = centresList.filter(c => !centresSoumis.includes(c));
    document.getElementById("centresRestants").innerText = centresRestants.length;
    
    const ul = document.getElementById("missingList");
    ul.innerHTML = "";
    
    if (centresRestants.length === 0) {
        document.getElementById("missingAlert").style.display = "none";
    } else {
        document.getElementById("missingAlert").style.display = "block";
        centresRestants.forEach(c => {
            const li = document.createElement("li");
            li.innerText = c;
            ul.appendChild(li);
        });
    }
}

// =====================================================
// SEARCH & FILTER
// =====================================================
function filterTable() {
    const searchValue = document.getElementById("searchInput").value.toLowerCase();
    const filterEtat = document.getElementById("filterEtat").value;
    const rows = document.querySelectorAll("#dataTable tbody tr:not(.centre-row)");
    const centreRows = document.querySelectorAll("#dataTable tbody tr.centre-row");
    
    // Track which centres have visible rows
    const visibleCentres = new Set();
    
    rows.forEach(row => {
        const matchSearch = !searchValue || row.dataset.searchable.includes(searchValue);
        const matchEtat = !filterEtat || row.dataset.etat === filterEtat;
        
        if (matchSearch && matchEtat) {
            row.style.display = "";
            visibleCentres.add(row.dataset.centre);
        } else {
            row.style.display = "none";
        }
    });
    
    // Show/hide centre rows based on visible children
    centreRows.forEach(row => {
        const centreName = row.cells[0].textContent.split(" (")[0].replace(/^.*? /, '');
        row.style.display = visibleCentres.has(centreName) || (!searchValue && !filterEtat) ? "" : "none";
    });
}

// =====================================================
// EDIT FUNCTIONS
// =====================================================
function editVehicle(centre, id) {
    const v = getVehicle(centre, id);
    if (!v) {
        showToast("Erreur", "V√©hicule non trouv√©", "error");
        return;
    }
    
    document.getElementById("editCentre").value = centre;
    document.getElementById("editIndex").value = id;
    document.getElementById("editType").value = v.type;
    document.getElementById("editImmat").value = v.immatriculation;
    document.getElementById("editChassis").value = v.chassis;
    document.getElementById("editAnnee").value = v.annee;
    document.getElementById("editKm").value = v.km;
    document.getElementById("editEtat").value = v.etat;
    document.getElementById("editCarburant").value = v.carburant || "Essence";
    
    // Handle carte grise preview in edit modal
    const editPreview = document.getElementById("editCarteGrisePreview");
    const editZone = document.getElementById("editCarteGriseZone");
    const editFileName = document.getElementById("editCarteGriseFileName");
    if (v.carteGriseImage) {
        editPreview.src = v.carteGriseImage;
        editPreview.classList.add("visible");
        editZone.classList.add("has-file");
        editFileName.textContent = "Image existante";
    } else {
        editPreview.classList.remove("visible");
        editZone.classList.remove("has-file");
        editFileName.textContent = "";
    }
    
    document.getElementById("editModal").classList.add("active");
}

function closeModal() {
    document.getElementById("editModal").classList.remove("active");
}

async function handleEditSubmit(e) {
    e.preventDefault();
    
    const centre = document.getElementById("editCentre").value;
    const id = document.getElementById("editIndex").value;
    const vehicle = getVehicle(centre, id);
    
    if (!vehicle) {
        showToast("Erreur", "V√©hicule non trouv√©", "error");
        return;
    }
    
    const updatedData = {
        ...vehicle,
        type: document.getElementById("editType").value,
        immatriculation: document.getElementById("editImmat").value.toUpperCase(),
        chassis: document.getElementById("editChassis").value.toUpperCase(),
        annee: document.getElementById("editAnnee").value,
        km: document.getElementById("editKm").value,
        etat: document.getElementById("editEtat").value,
        carburant: document.getElementById("editCarburant").value,
        modifiedAt: new Date().toLocaleDateString("fr-FR")
    };
    
    // Handle carte grise image update
    const editCgInput = document.getElementById("editCarteGrise");
    const editCgCompressed = editCgInput.dataset.compressed;
    if (editCgCompressed) {
        updatedData.carteGriseImage = editCgCompressed;
        editCgInput.dataset.compressed = "";
    }
    
    // Remove internal Firebase key before saving
    delete updatedData._key;
    
    if (firebaseReady) {
        try {
            await fbUpdate(centre, id, updatedData);
            closeModal();
            await fbGet();
            loadData();
            showToast("Modifi√©", "V√©hicule mis √† jour avec succ√®s", "success");
        } catch(err) {
            showToast("Erreur", "Erreur de mise √† jour: " + err.message, "error");
        }
    } else {
        const data = getData();
        const idx = parseInt(id);
        data[centre][idx] = updatedData;
        if (saveData(data)) {
            closeModal();
            loadData();
            showToast("Modifi√©", "V√©hicule mis √† jour avec succ√®s", "success");
        }
    }
}

// =====================================================
// DELETE FUNCTIONS
// =====================================================
function deleteVehicle(centre, id) {
    document.getElementById("deleteCentre").value = centre;
    document.getElementById("deleteIndex").value = id;
    document.getElementById("deleteModal").classList.add("active");
}

function closeDeleteModal() {
    document.getElementById("deleteModal").classList.remove("active");
}

function confirmDelete() {
    const centre = document.getElementById("deleteCentre").value;
    const id = document.getElementById("deleteIndex").value;
    
    if (firebaseReady) {
        fbDelete(centre, id).then(async () => {
            closeDeleteModal();
            await fbGet();
            loadData();
            showToast("Supprim√©", "V√©hicule supprim√© avec succ√®s", "success");
        }).catch(err => {
            showToast("Erreur", "Erreur de suppression: " + err.message, "error");
        });
    } else {
        const data = getData();
        const idx = parseInt(id);
        data[centre].splice(idx, 1);
        if (data[centre].length === 0) delete data[centre];
        if (saveData(data)) {
            closeDeleteModal();
            loadData();
            showToast("Supprim√©", "V√©hicule supprim√© avec succ√®s", "success");
        }
    }
}

// =====================================================
// EXPORT FUNCTIONS
// =====================================================
function exportExcel() {
    const data = getData();
    const rows = [];
    
    Object.keys(data).sort().forEach(centre => {
        data[centre].forEach(v => {
            rows.push({
                "Centre de Sant√©": centre,
                "Type": v.type,
                "Immatriculation": v.immatriculation,
                "N¬∞ Ch√¢ssis": v.chassis,
                "Ann√©e": v.annee,
                "Kilom√©trage": v.km,
                "√âtat": v.etat,
                "Carburant": v.carburant || "N/A",
                "Carte Grise": v.carteGriseImage ? "Oui (image jointe)" : "Non fournie",
                "Observations": v.observations || "",
                "Date D√©claration": v.date
            });
        });
    });
    
    if (rows.length === 0) {
        showToast("Attention", "Aucune donn√©e √† exporter", "warning");
        return;
    }
    
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    
    // Set column widths
    ws['!cols'] = [
        { wch: 30 }, { wch: 12 }, { wch: 15 }, { wch: 20 },
        { wch: 8 }, { wch: 12 }, { wch: 10 }, { wch: 12 },
        { wch: 18 }, { wch: 30 }, { wch: 15 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, "V√©hicules");
    XLSX.writeFile(wb, `rapport_vehicules_ATZ_${new Date().toISOString().split('T')[0]}.xlsx`);
    
    showToast("Export", "Fichier Excel g√©n√©r√© avec succ√®s", "success");
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
    const data = getData();
    
    if (Object.keys(data).length === 0) {
        showToast("Attention", "Aucune donn√©e √† exporter", "warning");
        return;
    }
    
    // Header
    doc.setFillColor(13, 59, 102);
    doc.rect(0, 0, 297, 30, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text("RAPPORT OFFICIEL - GESTION DU PARC AUTOMOBILE", 148, 12, { align: 'center' });
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text("Zone Sanitaire Allada-Toffo-Z√®", 148, 20, { align: 'center' });
    
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.text(`Date d'√©dition: ${new Date().toLocaleDateString('fr-FR')}`, 14, 40);
    
    // Statistics
    const totalVehicles = Object.values(data).reduce((sum, arr) => sum + arr.length, 0);
    const totalCentres = Object.keys(data).length;
    doc.text(`Total v√©hicules: ${totalVehicles} | Centres d√©clarants: ${totalCentres}/${centresList.length}`, 14, 48);
    
    let y = 58;
    
    // Collect all vehicles with carte grise images for appendix
    const cartesGrises = [];
    
    Object.keys(data).sort().forEach(centre => {
        // Check if we need a new page
        if (y > 180) {
            doc.addPage();
            y = 20;
        }
        
        doc.setFillColor(224, 242, 254);
        doc.rect(14, y - 5, 269, 8, 'F');
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(`${centre} (${data[centre].length} v√©hicule(s))`, 16, y);
        y += 4;
        
        // Collect carte grise images
        data[centre].forEach(v => {
            if (v.carteGriseImage) {
                cartesGrises.push({
                    centre: centre,
                    immatriculation: v.immatriculation,
                    type: v.type,
                    image: v.carteGriseImage
                });
            }
        });
        
        doc.autoTable({
            startY: y,
            head: [["Type", "Immatriculation", "Ch√¢ssis", "Ann√©e", "KM", "√âtat", "Carburant", "Carte Grise"]],
            body: data[centre].map(v => [
                v.type,
                v.immatriculation,
                v.chassis,
                v.annee,
                Number(v.km).toLocaleString(),
                v.etat,
                v.carburant || "N/A",
                v.carteGriseImage ? "‚úì Voir annexe" : "Non fournie"
            ]),
            theme: 'striped',
            headStyles: {
                fillColor: [13, 59, 102],
                fontSize: 9
            },
            styles: {
                fontSize: 8,
                cellPadding: 2
            },
            margin: { left: 14, right: 14 }
        });
        
        y = doc.lastAutoTable.finalY + 12;
    });
    
    // =====================================================
    // ANNEXE : Photos des Cartes Grises
    // =====================================================
    if (cartesGrises.length > 0) {
        doc.addPage();
        
        // Annexe header
        doc.setFillColor(13, 59, 102);
        doc.rect(0, 0, 297, 25, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text("ANNEXE - PHOTOS DES CARTES GRISES", 148, 16, { align: 'center' });
        
        let imgY = 35;
        
        cartesGrises.forEach((cg, idx) => {
            // Check if we need a new page (leave room for image + label)
            if (imgY > 140) {
                doc.addPage();
                imgY = 20;
            }
            
            // Vehicle info label
            doc.setTextColor(13, 59, 102);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`${idx + 1}. ${cg.type} - ${cg.immatriculation}`, 14, imgY);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.text(`Centre: ${cg.centre}`, 14, imgY + 5);
            
            imgY += 9;
            
            // Add the carte grise image
            try {
                const imgFormat = cg.image.includes('image/png') ? 'PNG' : 'JPEG';
                const imgWidth = 120;
                const imgHeight = 75;
                doc.addImage(cg.image, imgFormat, 14, imgY, imgWidth, imgHeight);
                
                // Draw border around image
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.rect(14, imgY, imgWidth, imgHeight);
                
                imgY += imgHeight + 15;
            } catch (err) {
                doc.setTextColor(230, 57, 70);
                doc.setFontSize(8);
                doc.text("‚ö† Erreur de chargement de l'image", 14, imgY + 10);
                imgY += 20;
            }
        });
    }
    
    // Footer on each page
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`Page ${i} / ${pageCount}`, 148, 200, { align: 'center' });
        doc.text("¬© Zone Sanitaire ATZ - Document g√©n√©r√© automatiquement", 148, 205, { align: 'center' });
    }
    
    doc.save(`rapport_vehicules_ATZ_${new Date().toISOString().split('T')[0]}.pdf`);
    showToast("Export", "Fichier PDF g√©n√©r√© avec succ√®s", "success");
}

// Close modals on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
        closeDeleteModal();
        closeLoginModal();
        closeImageViewer();
    }
});

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
            closeDeleteModal();
            closeLoginModal();
        }
    });
});

// Close image viewer on overlay click
document.getElementById('imageViewer').addEventListener('click', function(e) {
    if (e.target === this) {
        closeImageViewer();
    }
});
</script>

</body>
</html>
